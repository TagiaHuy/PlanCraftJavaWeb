<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlanCraft - Chi tiết giai đoạn</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/utilities.css">
    <link rel="stylesheet" href="/css/stage-detail.css">
    <link rel="stylesheet" href="/css/pomodoro.css">
    <link rel="stylesheet" href="/css/miniplayer.css">
    <link rel="stylesheet" href="/css/toast.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    
    <!-- Google Drive API -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="/dashboard" class="nav-brand">
                <i class="fas fa-rocket"></i> PlanCraft
            </a>
            <ul class="nav-menu">
                <li><a href="/dashboard" class="nav-link">Dashboard</a></li>
                <li><a href="/goals/create" class="nav-link">Tạo mục tiêu</a></li>
                <li><a href="/stages" class="nav-link">Giai đoạn</a></li>
                <li><a href="/users" class="nav-link">Quản lý</a></li>
                <li>
                    <form th:action="@{/logout}" method="post" style="display:inline;">
                        <button type="submit" class="nav-link" style="background:none; border:none; cursor:pointer;">Đăng xuất</button>
                    </form>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <div class="main-content">
            <div class="content">
                <!-- Breadcrumb -->
                <div class="breadcrumb">
                    <a href="/dashboard" class="breadcrumb-item">
                        <i class="fas fa-home"></i> Dashboard
                    </a>
                    <i class="fas fa-chevron-right"></i>
                    <a th:href="@{'/goals/' + ${stage.goal.id}}" class="breadcrumb-item" th:text="${stage.goal.name}">Mục tiêu</a>
                    <i class="fas fa-chevron-right"></i>
                    <span class="breadcrumb-item active" th:text="${stage.name}">Giai đoạn</span>
                </div>

                <!-- Stage Header -->
                <div class="stage-header">
                    <div class="stage-info">
                        <div class="stage-status-badge" th:class="${'stage-status-badge ' + stage.status.toLowerCase()}">
                            <i th:class="${stage.status == 'COMPLETED' ? 'fas fa-check-circle' : 
                                          stage.status == 'IN_PROGRESS' ? 'fas fa-clock' : 'fas fa-pause-circle'}"></i>
                            <span th:text="${stage.status == 'COMPLETED' ? 'Hoàn thành' : 
                                           stage.status == 'IN_PROGRESS' ? 'Đang thực hiện' : 'Chưa bắt đầu'}">Trạng thái</span>
                        </div>
                        <h1 class="stage-title" th:text="${stage.name}">Tên giai đoạn</h1>
                        <p class="stage-description" th:text="${stage.description}">Mô tả giai đoạn</p>
                    </div>
                    <div class="stage-actions">
                        <button class="btn btn-secondary" onclick="editStage()">
                            <i class="fas fa-edit"></i>
                            Chỉnh sửa
                        </button>
                        <a th:href="@{'/tasks/create?stageId=' + ${stage.id}}" class="btn btn-primary">
                            <i class="fas fa-plus"></i>
                            Thêm nhiệm vụ
                        </a>
                    </div>
                </div>

                <!-- Stage Statistics -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div class="stat-content">
                            <h3 th:text="${#temporals.format(stage.startDate, 'dd/MM')} + ' - ' + ${#temporals.format(stage.endDate, 'dd/MM/yyyy')}">Thời gian</h3>
                            <p>Thời gian thực hiện</p>
                            <div class="stat-detail">
                                <span th:text="${#temporals.format(stage.startDate, 'dd/MM')} + ' - ' + ${#temporals.format(stage.endDate, 'dd/MM/yyyy')}">Thời gian</span>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
                            <i class="fas fa-list-check"></i>
                        </div>
                        <div class="stat-content">
                            <h3 th:text="${#lists.size(stage.tasks)}">0</h3>
                            <p>Tổng nhiệm vụ</p>
                            <div class="stat-detail">
                                <span th:text="${#lists.size(stage.tasks.?[status == 'IN_PROGRESS'])} + ' đang làm'">0 đang làm</span>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">
                            <i class="fas fa-check-double"></i>
                        </div>
                        <div class="stat-content">
                            <h3 th:text="${#lists.size(stage.tasks.?[status == 'COMPLETED'])}">0</h3>
                            <p>Đã hoàn thành</p>
                            <div class="stat-detail">
                                <span th:if="${#lists.size(stage.tasks) > 0}" 
                                      th:text="${#numbers.formatDecimal((#lists.size(stage.tasks.?[status == 'COMPLETED']) * 100.0 / #lists.size(stage.tasks)), 1, 1)} + '%'">0%</span>
                                <span th:if="${#lists.size(stage.tasks) == 0}">0%</span>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #43e97b, #38f9d7);">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-content">
                            <h3 th:text="${stage.progressPercentage != null ? #numbers.formatDecimal(stage.progressPercentage, 1, 1) + '%' : '0%'}">0%</h3>
                            <p>Tiến độ tổng thể</p>
                            <div class="stat-detail">
                                <span th:text="${#lists.size(stage.tasks.?[status == 'NOT_STARTED'])} + ' chưa làm'">0 chưa làm</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Progress Overview -->
                <div class="progress-overview">
                    <div class="progress-header">
                        <h2><i class="fas fa-chart-line"></i> Tổng quan tiến độ</h2>
                        <div class="progress-percentage" th:text="${stage.progressPercentage != null ? #numbers.formatDecimal(stage.progressPercentage, 1, 1) + '%' : '0%'}">0%</div>
                    </div>
                    <div class="progress-bar-large">
                        <div class="progress-fill-large" th:style="'width: ' + ${stage.progressPercentage != null ? stage.progressPercentage : 0} + '%'"></div>
                    </div>
                    <div class="progress-stats">
                        <span th:text="${#lists.size(stage.tasks.?[status == 'COMPLETED'])} + ' / ' + ${#lists.size(stage.tasks)} + ' nhiệm vụ hoàn thành'">0 / 0 nhiệm vụ hoàn thành</span>
                    </div>
                </div>

                <!-- Pomodoro Timer -->
                <div class="pomodoro-section">
                    <div class="pomodoro-header" onclick="togglePomodoroDropdown()" style="cursor: pointer;" 
                         title="Click để mở/đóng Pomodoro Timer" role="button" tabindex="0"
                         onkeypress="if(event.key==='Enter'||event.key===' ') togglePomodoroDropdown()">
                        <h2><i class="fas fa-clock"></i> Pomodoro Timer</h2>
                        <div class="header-timer" id="headerTimer" style="display: none;">
                            <span class="header-time" id="headerTime">25:00</span>
                            <div class="header-controls">
                                <button class="header-control-btn" id="headerStartBtn" onclick="event.stopPropagation(); startPomodoro();" title="Bắt đầu">
                                    <i class="fas fa-play"></i>
                                </button>
                                <button class="header-control-btn" id="headerPauseBtn" onclick="event.stopPropagation(); pausePomodoro();" style="display: none;" title="Tạm dừng">
                                    <i class="fas fa-pause"></i>
                                </button>
                                <button class="header-control-btn" id="headerResetBtn" onclick="event.stopPropagation(); resetPomodoro();" title="Đặt lại">
                                    <i class="fas fa-redo"></i>
                                </button>
                                <button class="header-control-btn" id="headerSoundToggle" onclick="event.stopPropagation(); toggleSound();" title="Bật/Tắt âm thanh">
                                    <i class="fas fa-volume-up"></i>
                                </button>
                            </div>
                        </div>
                        <i class="fas fa-chevron-down" id="pomodoroDropdownIcon" aria-label="Toggle dropdown"></i>
                    </div>
                    
                    <div class="pomodoro-container" id="pomodoroContainer" style="display: none;">
                        <div class="pomodoro-timer">
                            <div class="timer-display-container">
                                <div class="timer-display" id="timerDisplay">25:00</div>
                                <div class="timer-label" id="timerLabel">Thời gian làm việc</div>
                            </div>
                            <div class="timer-controls">
                                <button class="timer-control-btn" id="startBtn" onclick="startPomodoro()" title="Bắt đầu">
                                    <i class="fas fa-play"></i>
                                </button>
                                <button class="timer-control-btn" id="pauseBtn" onclick="pausePomodoro()" style="display: none;" title="Tạm dừng">
                                    <i class="fas fa-pause"></i>
                                </button>
                                <button class="timer-control-btn" id="resetBtn" onclick="resetPomodoro()" title="Đặt lại">
                                    <i class="fas fa-redo"></i>
                                </button>
                                <button class="timer-control-btn" id="soundToggle" onclick="toggleSound()" title="Bật/Tắt âm thanh">
                                    <i class="fas fa-volume-up"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="pomodoro-settings">
                            <div class="setting-group">
                                <label>Thời gian làm việc (phút):</label>
                                <input type="number" id="workTime" value="25" min="1" max="60" class="setting-input">
                            </div>
                            <div class="setting-group">
                                <label>Thời gian nghỉ ngơi (phút):</label>
                                <input type="number" id="breakTime" value="5" min="1" max="30" class="setting-input">
                            </div>
                            <div class="setting-group">
                                <label>Chu kỳ dài (phút):</label>
                                <input type="number" id="longBreakTime" value="15" min="1" max="60" class="setting-input">
                            </div>
                        </div>

                        <!-- Custom Audio Settings -->
                        <div class="audio-settings">
                            <h3><i class="fas fa-music"></i> Tùy chỉnh âm thanh</h3>
                            
                            <!-- Storage Options -->
                            <div class="storage-options">
                                <label class="storage-option">
                                    <input type="radio" name="storageMode" value="local" checked>
                                    <span class="radio-custom"></span>
                                    <div class="storage-info">
                                        <i class="fas fa-hdd"></i>
                                        <span>LocalStorage (5MB)</span>
                                    </div>
                                </label>
                                <label class="storage-option">
                                    <input type="radio" name="storageMode" value="google">
                                    <span class="radio-custom"></span>
                                    <div class="storage-info">
                                        <i class="fab fa-google-drive"></i>
                                        <span>Google Drive (15GB)</span>
                                    </div>
                                </label>
                            </div>

                            <!-- Google Drive Authentication -->
                            <div class="google-auth-section" id="googleAuthSection" style="display: none;">
                                <div class="auth-status" id="authStatus">
                                    <i class="fas fa-user-times"></i>
                                    <span>Chưa đăng nhập Google Drive</span>
                                </div>
                                <button class="btn btn-primary btn-sm" onclick="authenticateGoogleDrive()" id="googleAuthBtn">
                                    <i class="fab fa-google"></i> Đăng nhập Google Drive
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="signOutGoogleDrive()" id="googleSignOutBtn" style="display: none;">
                                    <i class="fas fa-sign-out-alt"></i> Đăng xuất
                                </button>
                                <button class="btn btn-outline-info btn-sm" onclick="checkGoogleDriveStatus()" title="Kiểm tra trạng thái Google Drive API">
                                    <i class="fas fa-bug"></i> Debug
                                </button>
                            </div>
                            
                            <div class="audio-options">
                                <div class="audio-option">
                                    <label>
                                        <input type="radio" name="audioMode" value="default" checked>
                                        <span class="radio-custom"></span>
                                        Âm thanh mặc định
                                    </label>
                                </div>
                                <div class="audio-option">
                                    <label>
                                        <input type="radio" name="audioMode" value="custom">
                                        <span class="radio-custom"></span>
                                        Âm thanh tùy chỉnh
                                    </label>
                                </div>
                            </div>
                            
                            <div class="custom-audio-section" id="customAudioSection" style="display: none;">
                                <div class="audio-type-selector">
                                    <label>Loại âm thanh:</label>
                                    <select id="audioType" class="setting-input">
                                        <option value="work">Âm thanh làm việc</option>
                                        <option value="break">Âm thanh nghỉ ngơi</option>
                                        <option value="universal">Âm thanh cố định (dùng cho cả hai)</option>
                                    </select>
                                </div>
                                
                                <div class="audio-upload-area">
                                    <div class="upload-zone" id="uploadZone">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                        <p>Kéo thả file âm thanh vào đây hoặc <span class="upload-link" onclick="document.getElementById('audioFile').click()">chọn file</span></p>
                                        <p class="upload-hint" id="uploadHint">Hỗ trợ: MP3, WAV, OGG (tối đa 5MB)</p>
                                    </div>
                                    <input type="file" id="audioFile" accept="audio/*" style="display: none;" onchange="handleAudioUpload(event)">
                                </div>
                                
                                <div class="audio-preview" id="audioPreview" style="display: none;">
                                    <div class="preview-info">
                                        <i class="fas fa-music"></i>
                                        <span id="audioFileName">Tên file</span>
                                        <button class="btn btn-sm btn-outline-danger" onclick="removeAudio()">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                    <audio id="audioPreviewPlayer" controls style="width: 100%; margin-top: 10px;"></audio>
                                </div>
                                
                                <div class="audio-actions">
                                    <button class="btn btn-primary btn-sm" onclick="saveCustomAudio()">
                                        <i class="fas fa-save"></i> Lưu âm thanh
                                    </button>
                                    <button class="btn btn-secondary btn-sm" onclick="resetToDefault()">
                                        <i class="fas fa-undo"></i> Khôi phục mặc định
                                    </button>
                                    <button class="btn btn-info btn-sm" onclick="showSavedAudioInfo()">
                                        <i class="fas fa-info-circle"></i> Xem âm thanh đã lưu
                                    </button>
                                    <button class="btn btn-warning btn-sm" onclick="showStorageManagementDialog()" id="storageManageBtn">
                                        <i class="fas fa-hdd"></i> Quản lý dung lượng
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="pomodoro-stats">
                            <div class="stat-item">
                                <i class="fas fa-check-circle"></i>
                                <span>Chu kỳ hoàn thành: <span id="completedCycles">0</span></span>
                            </div>
                            <div class="stat-item">
                                <i class="fas fa-clock"></i>
                                <span>Tổng thời gian: <span id="totalTime">00:00</span></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tasks Section -->
                <div class="tasks-section">
                    <div class="section-header">
                        <h2><i class="fas fa-list-check"></i> Danh sách nhiệm vụ</h2>
                        <div class="section-actions">
                            <div class="task-hint">
                                <i class="fas fa-info-circle"></i>
                                <span>Click vào nhiệm vụ để thay đổi trạng thái</span>
                            </div>
                            <a th:href="@{'/tasks/create?stageId=' + ${stage.id}}" class="btn btn-primary btn-sm">
                                <i class="fas fa-plus"></i>
                                Thêm nhiệm vụ
                            </a>
                        </div>
                    </div>

                    <!-- Tasks List -->
                    <div class="tasks-list" id="tasksList">
                        <div th:if="${#lists.isEmpty(stage.tasks)}" class="empty-tasks">
                            <div class="empty-icon">
                                <i class="fas fa-clipboard-list"></i>
                            </div>
                            <h3>Chưa có nhiệm vụ nào</h3>
                            <p>Tạo nhiệm vụ đầu tiên để bắt đầu thực hiện giai đoạn này</p>
                            <a th:href="@{'/tasks/create?stageId=' + ${stage.id}}" class="btn btn-primary">
                                <i class="fas fa-plus"></i>
                                Thêm nhiệm vụ đầu tiên
                            </a>
                        </div>

                        <div th:each="task : ${stage.tasks}" class="task-item fade-in" th:data-task-id="${task.id}" 
                             title="Click để thay đổi trạng thái nhiệm vụ">
                            <div class="task-checkbox">
                                <input type="checkbox" th:checked="${task.status == 'COMPLETED'}" 
                                       th:onchange="'toggleTaskStatus(' + ${task.id} + ', this.checked)'" 
                                       class="task-checkbox-input"
                                       title="Click để thay đổi trạng thái nhiệm vụ">
                                <div class="checkbox-custom"></div>
                            </div>
                            
                            <div class="task-content">
                                <div class="task-header">
                                    <h3 class="task-title" th:text="${task.name}">Tên nhiệm vụ</h3>
                                    <div class="task-actions">
                                        <button class="action-btn" th:onclick="'editTask(' + ${task.id} + ')'" title="Chỉnh sửa">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="action-btn" th:onclick="'deleteTask(' + ${task.id} + ')'" title="Xóa">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <p class="task-description" th:text="${task.description}">Mô tả nhiệm vụ</p>
                                <div class="task-status" th:class="${'task-status ' + task.status.toLowerCase()}">
                                    <i th:class="${task.status == 'COMPLETED' ? 'fas fa-check-circle' : 
                                                  task.status == 'IN_PROGRESS' ? 'fas fa-clock' : 'fas fa-pause-circle'}"></i>
                                    <span th:text="${task.status == 'COMPLETED' ? 'Hoàn thành' : 
                                                   task.status == 'IN_PROGRESS' ? 'Đang thực hiện' : 'Chưa làm'}">Trạng thái</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Audio Elements for Pomodoro -->
    <audio id="workCompleteSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT" type="audio/wav">
    </audio>
    <audio id="breakStartSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT" type="audio/wav">
    </audio>
    <audio id="longBreakSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT" type="audio/wav">
    </audio>

    <!-- Miniplayer for Pomodoro -->
    <div class="miniplayer" id="miniplayer" style="display: none;">
        <div class="miniplayer-content">
            <div class="miniplayer-info">
                <div class="miniplayer-title">
                    <i class="fas fa-clock"></i>
                    <span id="miniplayerLabel">Pomodoro Timer</span>
                </div>
                <div class="miniplayer-time" id="miniplayerTime">25:00</div>
            </div>
            <div class="miniplayer-controls">
                <button class="miniplayer-btn" onclick="toggleMiniplayerPomodoro()" id="miniplayerToggle">
                    <i class="fas fa-pause"></i>
                </button>
                <button class="miniplayer-btn" onclick="resetMiniplayerPomodoro()">
                    <i class="fas fa-redo"></i>
                </button>
                <button class="miniplayer-btn" onclick="expandMiniplayer()">
                    <i class="fas fa-expand"></i>
                </button>
                <button class="miniplayer-btn" onclick="hideMiniplayer()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Thêm các file JS đã tách ở cuối body -->
    <script src="/js/toast.js"></script>
    <script src="/js/task-management.js"></script>
    <script src="/js/pomodoro.js"></script>
    <script src="/js/miniplayer.js"></script>
    <script src="/js/custom-audio.js"></script>
    <script src="/js/user.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
        if (typeof initializePomodoro === 'function') {
          initializePomodoro();
        }
        if (typeof initializeTaskManagement === 'function') {
          initializeTaskManagement();
        }
      });
    </script>
</body>
</html> 